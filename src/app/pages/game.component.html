<ng-container *ngIf="consent === 'true'">
  <survey
    [model]="postSurvey"
    (submitSurvey)="sendData($event, 'post'); state = status.LEADERBOARD"
    *ngIf="state === status.POST"
  ></survey>

  <survey
    [model]="preSurvey"
    (submitSurvey)="sendData($event, 'pre'); state = status.WAITING; start()"
    *ngIf="state === status.PRE"
  ></survey>
  <div class="p-4" *ngIf="![status.PRE, status.POST].includes(state)">
    <ng-container
      *ngIf="
        [status.TEXT1, status.TEXT2, status.TEXT3, status.TEXT4].includes(state)
      "
    >
      <ng-container *ngFor="let step of textToShow; let idx = index">
        <div
          *ngIf="currentText === idx + 1"
          class="w-md-100 mx-auto w-lg-75 mt-4"
        >
          <p>
            <br />
            <span
              class="badge bg-warning text-center w-100 p-2 fs-6 lh-base text-dark text-break text-wrap"
              style="background-color: #99b0a9 !important;"
            >
              {{ "read_carefully" | label }}<br />
              <hr class="my-1" />
              {{ "next_to_continue" | label }}
            </span>
          </p>
          <div class="border rounded">
            <h5 class="text-center text-break text-wrap mb-0 pb-0 p-3" style="color:#9bfebe; font-weight: bold;">
              {{ step.text.title }}
            </h5>

            <div
              class="badge text-uppercase p-2"
              style="display: flex; align-items: center"
            >
              <img
                [src]="
                  step.text.labeled
                    ? step.text.type === 'ai'
                      ? 'assets/profiles/Bot.jpg'
                      : 'assets/profiles/human.jpg'
                    : 'assets/profiles/QuestionMark.jpg'
                "
                [attr.alt]="
                  step.text.labeled
                    ? step.text.type === 'ai'
                      ? 'Bot profile image'
                      : 'Human profile image'
                    : 'Unknown profile image'
                "
                style="
                  width: 50px;
                  height: 50px;
                  border-radius: 50%;
                  object-fit: cover;
                "
              />
              <div class="p-2 largerLabel">
                <strong>
                  {{
                    step.text.labeled
                      ? step.text.type === "ai"
                        ? ("AI_author" | label)
                        : ("Human_author" | label)
                      : ("Unknown_author" | label)
                  }}</strong
                >
              </div>
            </div>

            <div
              class="text-break text-wrap p-3"
              [innerHTML]="markdownToHtml(step.text.text)"
              [appCstTracker]="'text-' + idx"
            ></div>
          </div>
          <hr />

          <div class="d-block my-3">
            <label class="form-label font-weight-bold text-center w-100">
              {{ "t_whoDoYouThinkIsTheAuthor" | label }}
            </label>
            <!-- <input
              type="range"
              class="form-range custom-slider"
              min="0"
              max="10"
              step="1"
              [(ngModel)]="step.humanSoundness"
              [ngClass]="{ unconfirmed: !interacted.humanSoundness }"
              (change)="markInteracted('humanSoundness')"
              (mousedown)="markInteracted('humanSoundness')"
              (touchstart)="markInteracted('humanSoundness')"
            /> -->
            <div
              class="d-flex flex-column align-items-center"
              [title]="
                step.text.labeled
                  ? ('t_known_author' | label) +
                    ' (' +
                    (step.text.type === 'ai'
                      ? ('AI' | label)
                      : ('human' | label)) +
                    ')'
                  : ''
              "
            >
            <span *ngIf="step.text.labeled" class="slider-note"
                >{{ "t_known_author" | label
                }}{{
                  step.text.type === "ai" ? ("AI" | label) : ("human" | label)
                }}</span
              >
              <input
                type="range"
                class="form-range custom-slider"
                min="0"
                max="10"
                step="1"
                [ngModel]="
                  step.text.labeled
                    ? step.text.type === 'ai'
                      ? 0
                      : 10
                    : step.humanSoundness
                "
                (ngModelChange)="
                  step.text.labeled
                    ? markInteracted('humanSoundness')
                    : (step.humanSoundness = $event)
                "
                [disabled]="step.text.labeled"
                [ngClass]="{
                  unconfirmed: !interacted.humanSoundness,
                  'locked-slider': step.text.labeled
                }"
                (change)="
                  !step.text.labeled && markInteracted('humanSoundness')
                "
                (mousedown)="
                  !step.text.labeled && markInteracted('humanSoundness');
                  countSliderInteraction(step, 'humanSoundness')
                "
                (touchstart)="
                  !step.text.labeled && markInteracted('humanSoundness');
                  countSliderInteraction(step, 'humanSoundness')
                "
              />

              
            </div>

            <div class="d-flex justify-content-between">
              <span class="w-33">{{ "AI" | label }}</span>
              <span class="w-33 text-center" *ngIf="interacted.humanSoundness">
                {{ step.humanSoundness }} / 10
              </span>
              <span class="w-33 text-end">{{ "human" | label }}</span>
            </div>
          </div>

          <div class="d-block my-3">
            <label class="form-label font-weight-bold text-center w-100">
              {{ "t_accuracyRate" | label }}
            </label>
            <input
              type="range"
              class="form-range with-ticks"
              min="0"
              max="10"
              step="1"
              [(ngModel)]="step.accuracy"
              [ngClass]="{ unconfirmed: !interacted.accuracy }"
              (change)="markInteracted('accuracy')"
              (mousedown)="markInteracted('accuracy');
              countSliderInteraction(step, 'accuracy')"
              (touchstart)="markInteracted('accuracy');
              countSliderInteraction(step, 'accuracy')"
            />
            <div class="d-flex justify-content-between">
              <span class="w-33">{{ "Very_low" | label }}</span>
              <span class="w-33 text-center" *ngIf="interacted.accuracy">
                {{ step.accuracy }} / 10
              </span>
              <span class="w-33 text-end">{{ "Very_high" | label }}</span>
            </div>
          </div>

          <div class="d-block my-3">
            <label class="form-label font-weight-bold text-center w-100">
              {{ "t_readabilityRate" | label }}
            </label>
            <input
              type="range"
              class="form-range with-ticks"
              min="0"
              max="10"
              step="1"
              [(ngModel)]="step.readability"
              [ngClass]="{ unconfirmed: !interacted.readability }"
              (change)="markInteracted('readability')"
              (mousedown)="markInteracted('readability');
              countSliderInteraction(step, 'readability')"
              (touchstart)="markInteracted('readability');
              countSliderInteraction(step, 'readability')"
            />
            <div class="d-flex justify-content-between">
              <span class="w-33">{{ "Very_low" | label }}</span>
              <span class="w-33 text-center" *ngIf="interacted.readability">
                {{ step.readability }} / 10
              </span>
              <span class="w-33 text-end">{{ "Very_high" | label }}</span>
            </div>
          </div>

          <div class="d-flex justify-content-end mt-3 gap-3">
            <div class="text-warning text-small">
              <span *ngIf="!allInteracted()" class="text-warning d-block">
                {{ "t_errorQuestions" | label }}
              </span>
            </div>
            <button
              class="btn btn-warning text-dark"
              (click)="nextText()"
              [disabled]="!allInteracted()"
            >
              {{ "Next" | label }}
            </button>
          </div>
        </div>
      </ng-container>
    </ng-container>
    <ng-container *ngIf="[status.TEXT5].includes(state)">
      <ng-container *ngFor="let step of lastTextToShow; let idx = index">
        <div class="text-container" [appCstTracker]="'text-5'"></div>
        <div class="w-md-100 mx-auto w-lg-75 mt-4">
          <p>
            <br />
            <span
              class="badge bg-warning text-center w-100 p-2 fs-6 lh-base text-dark text-break text-wrap"
              style="background-color: #99b0a9 !important;"

            >
              {{ "read_carefully" | label }}<br />
              <hr class="my-1" />
              <b>
                <!-- <i class="fa fa-exclamation-triangle"></i> -->
                {{ "additional_highlight" | label }}<br />
                <hr class="my-1" />
                {{ "next_to_continue" | label }}
              </b>
            </span>
          </p>
          <div class="border rounded">
 

            <!--div
              class="badge text-uppercase p-2"
              *ngIf="step?.lastText"
              style="display: flex; align-items: center"
            ></div-->
            <app-text-highlight
            [title]="step.lastText?.title"
              [textContent]="markdownToHtml(step.lastText.text)"
              (highlightSectionsChange)="step.highlightSections = $event"
            >
            </app-text-highlight>
          </div>
          <hr />
          <div class="d-block my-3" *ngIf="step">
            <label class="form-label font-weight-bold text-center w-100">
              {{ "t_whoDoYouThinkIsTheAuthor" | label }}
            </label>
            <input
              type="range"
              class="form-range custom-slider"
              min="0"
              max="10"
              step="1"
              [(ngModel)]="step.humanSoundness"
              [ngClass]="{ unconfirmed: !interacted.humanSoundness }"
              (change)="markInteracted('humanSoundness')"
              (mousedown)="markInteracted('humanSoundness');
              countSliderInteraction(step, 'humanSoundness')"
              (touchstart)="markInteracted('humanSoundness');
              countSliderInteraction(step, 'humanSoundness')"
            />
            <div class="d-flex justify-content-between">
              <span class="w-33">{{ "AI" | label }}</span>
              <span class="w-33 text-center" *ngIf="interacted.humanSoundness">
                {{ step.humanSoundness }} / 10
              </span>
              <span class="w-33 text-end">{{ "human" | label }}</span>
            </div>
          </div>
          <div class="d-block my-3" *ngIf="step">
            <label class="form-label font-weight-bold text-center w-100">
              {{ "t_accuracyRate" | label }}
            </label>
            <input
              type="range"
              class="form-range with-ticks"
              min="0"
              max="10"
              step="1"
              [(ngModel)]="step.accuracy"
              [ngClass]="{ unconfirmed: !interacted.accuracy }"
              (change)="markInteracted('accuracy')"
              (mousedown)="markInteracted('accuracy');
              countSliderInteraction(step, 'accuracy')"
              (touchstart)="markInteracted('accuracy');
              countSliderInteraction(step, 'accuracy')"
            />
            <div class="d-flex justify-content-between">
              <span class="w-33">{{ "Very_low" | label }}</span>
              <span class="w-33 text-center" *ngIf="interacted.accuracy">
                {{ step.accuracy }} / 10
              </span>
              <span class="w-33 text-end">{{ "Very_high" | label }}</span>
            </div>
          </div>

          <div class="d-block my-3" *ngIf="step">
            <label class="form-label font-weight-bold text-center w-100">
              {{ "t_readabilityRate" | label }}
            </label>
            <input
              type="range"
              class="form-range with-ticks"
              min="0"
              max="10"
              step="1"
              [(ngModel)]="step.readability"
              [ngClass]="{ unconfirmed: !interacted.readability }"
              (change)="markInteracted('readability')"
              (mousedown)="markInteracted('readability');
              countSliderInteraction(step, 'readability')"
              (touchstart)="markInteracted('readability');
              countSliderInteraction(step, 'readability')"
            />
            <div class="d-flex justify-content-between">
              <span class="w-33">{{ "Very_low" | label }}</span>
              <span class="w-33 text-center" *ngIf="interacted.readability">
                {{ step.readability }} / 10
              </span>
              <span class="w-33 text-end">{{ "Very_high" | label }}</span>
            </div>
          </div>

          <div class="d-flex justify-content-end mt-3 gap-3">
            <div class="text-warning text-small">
              <span
                *ngIf="!step?.highlightSections?.length"
                class="text-warning d-block"
              >
                {{ "t_errorHighlight" | label }}<br />
              </span>
              <span *ngIf="!allInteracted()" class="text-warning d-block">
                {{ "t_errorQuestions" | label }}
              </span>
            </div>
            <button
              class="btn btn-warning text-dark"
              (click)="toPostSurvey()"
              [disabled]="!allInteracted() || !step?.highlightSections?.length"
            >
              {{ "Next" | label }}
            </button>
          </div>
        </div>
      </ng-container>
    </ng-container>
    <ng-container *ngIf="state === status.FINISHED">
      <div [innerHTML]="debriefHtml"></div>
      <!-- <button class="btn btn-primary mt-2" (click)="showLeaderboard()">
        {{ "next_to_continue" | label }}       
        </button> -->
      <button class="btn btn-primary mt-2" (click)="showLeaderboard()">
        <div [innerHTML]="leaderboardHtml"></div>
      </button>
      <hr class="my-4" />

      <!-- <div class="w-md-100 mx-auto w-lg-75 mt-4">
        <h2>Thank You for participating</h2>

        <p class="mt-4">
          Please note that the texts you read during this study
          <strong>intentionally contained errors</strong>. You should not rely
          on them as accurate or trustworthy information.
        </p>

        <p class="mt-3">
          The goal of this study was to explore how people interact with text
          depending on how it is
          <strong>labeled and attributed</strong>, specifically, how authorship
          affects attention and perceptions of credibility.
        </p>

        <p class="mt-3">
          If you have any questions, would like to 
          report an issue, or want to
          share feedback about the experience, feel free to contact me at:
          <br />
          <a href="mailto:alessia.bogoni@stud-mail.uni-wuerzburg.de">
            alessia.bogoni&#64;stud-mail.uni-wuerzburg.de
          </a>
        </p>

        <p class="mt-4">
          When you're ready, click the button below to view the leaderboard.
        </p>

        <button class="btn btn-primary mt-2" (click)="showLeaderboard()">
          View Leaderboard
        </button>

        <hr class="my-4" />
      </div> -->
    </ng-container>

    <ng-container *ngIf="state === status.LEADERBOARD && lang">
      <app-leaderboard></app-leaderboard>
    </ng-container>
  </div>
</ng-container>
